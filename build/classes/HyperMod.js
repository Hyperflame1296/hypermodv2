class HyperMod{ui=new Object;locations=new Object;bindings=new Object;styles=new Object;lsSettings=new Object;fileData=new Map;fpsHist=new Array;player=new Player;npsTracker=new NPSTracker;currentFile;version="v0.2.0";defaultSettings={forceInfNoteQuota:!0,trackNPS:!1,connectUrl:"wss://mppclone.com",enableClientSidePlayback:!1,enableChannelColors:!0,removeWorkerTimer:!0,removeNameBouncing:!0,removeNoteBouncing:!0,removeKeyShadows:!0,removeKeyGradients:!1,removeKeyFade:!0,enableBlipLimit:!0,blipLimit:8,removeHyperModText:!1,removeRainbowGraphics:!1,enableFpsGraph:!0,fpsCalculationInterval:125,noteVisualizerSpeed:100,enableNoteColors:!0};settings={forceInfNoteQuota:!0,trackNPS:!1,connectUrl:"wss://mppclone.com",enableClientSidePlayback:!1,enableChannelColors:!0,removeWorkerTimer:!0,removeNameBouncing:!0,removeNoteBouncing:!0,removeKeyShadows:!0,removeKeyGradients:!1,removeKeyFade:!0,enableBlipLimit:!0,blipLimit:8,removeHyperModText:!1,removeRainbowGraphics:!1,enableFpsGraph:!0,fpsCalculationInterval:125,enableNoteVisualizer:!0,noteVisualizerSpeed:100,enableNoteColors:!0};channelColors=["#ff0000","#ff8800","#ffff00","#88ff00","#00ff00","#00ff44","#00ff88","#00ffbb","#00ffff","#0088ff","#0000ff","#8800ff","#ff00ff","#ff00bb","#ff0088","#ff0044"];canvas=document.createElement("canvas");ctx=this.canvas?.getContext("2d");now=performance.now();frames=0;fps=0;lastTime=performance.now();prefix="$";tags={log:`[HyperMod ${this.version}] - `,success:`[HyperMod ${this.version}] - [✅] - `,warn:`[HyperMod ${this.version}] - [⚠] - `,error:`[HyperMod ${this.version}] - [❌] - `};commands=[{name:"help",description:"Show all commands.",syntax:`${this.prefix}help [command]`,func:(e,t)=>{e[0]?.trim();if(""===(e[1]?.trim()??"")){let e=this.tags.success+"Commands: ";for(let t of this.commands)e+=`\`${t.name}\`${this.commands.indexOf(t)+1===this.commands.length?"":", "}`;MPP.chat.send(e)}else MPP.chat.send("a")}},{name:"js",description:"Evaluates JavaScript code.",syntax:`${this.prefix}js [command]`,func:(e,t)=>{let s=e.slice(1).join(" ");this.evalCode(s).then(e=>{let t="unknown type";switch(typeof e){case"number":case"function":case"symbol":t=e.toString();break;case"bigint":t=e.toString()+"n";break;case"string":t=e;break;case"boolean":t=e?"true":"false";break;case"object":t=JSON.stringify(e);break;case"undefined":t="undefined";break;default:t="unknown type"}MPP.chat.send(`[✅] » \`${t}\``)}).catch(e=>{MPP.chat.send(`[❌] » \`${e}\``)})}}];constructor(){if("undefined"!=typeof MPP&&void 0!==MPP.addons?.hyperMod)throw Error`no...`;this.loadUI(),this.getSettings(),this.updateSettings(),$(this.canvas).addClass("hypermod");let e=["a-1","as-1","b-1","c0","cs0","d0","ds0","e0","f0","fs0","g0","gs0","a0","as0","b0","c1","cs1","d1","ds1","e1","f1","fs1","g1","gs1","a1","as1","b1","c2","cs2","d2","ds2","e2","f2","fs2","g2","gs2","a2","as2","b2","c3","cs3","d3","ds3","e3","f3","fs3","g3","gs3","a3","as3","b3","c4","cs4","d4","ds4","e4","f4","fs4","g4","gs4","a4","as4","b4","c5","cs5","d5","ds5","e5","f5","fs5","g5","gs5","a5","as5","b5","c6","cs6","d6","ds6","e6","f6","fs6","g6","gs6","a6","as6","b6","c7"];this.player.on("midiEvent",t=>{if("undefined"==typeof MPP)return;let s,i=(t.channel??0)%16,a=MPP.client.getOwnParticipant(),n=this.lsSettings.enableChannelColors?{...a,color:this.channelColors[i]}:a;switch(t.type){case 8:if(s=e[t.note-21],!s)return;this.lsSettings.enableClientSideMIDIPlayer?MPP.piano.stop(s,n):MPP.release(s);break;case 9:if(s=e[t.note-21],!s)return;this.lsSettings.enableClientSidePlayback?MPP.piano.play(s,t.velocity/127,n):MPP.press(s,t.velocity/127)}});let t=()=>{this.canvasUpdate(),requestAnimationFrame(t)};t()}evalCode(a){return new Promise((resolve,reject)=>{try{let res=eval(a);resolve(res)}catch(e){reject(e)}})}receiveMessage(e){if("undefined"==typeof MPP)return;let t=e.a?.trim().split(" ")??[],s=t[0]?.trim()??"";t[1]?.trim();if(s.startsWith(this.prefix))try{let i=this.commands.find(e=>e.name===s.replace(this.prefix,""));if(!i)return MPP.chat.send(this.tags.error+`No such command \`${s}\``);i.func(t,e)}catch(e){MPP.chat.send(this.tags.error`${e}`)}}canvasUpdate(){this.canvas.width=innerWidth,this.canvas.height=innerHeight;let e=$("div.ugly-button#hypermod-btn"),t=performance.now()/8%360;if(this.lsSettings.removeRainbowGraphics||e.css({"border-color":`hsl(${t}, 100%, 90%)`}),this.ctx.font="30px monospace",this.ctx.fillStyle=this.lsSettings.removeRainbowGraphics?"#fff":`hsl(${t}, 100%, 90%)`,this.ctx.lineWidth=2,this.ctx.strokeStyle="#fff",this.lsSettings.removeHyperModText||(this.ctx.textAlign="center",this.ctx.fillText("HyperMod v2",this.canvas.width/2,130),this.ctx.fillStyle="#ffffff6b",this.ctx.font="italic 20px monospace",this.ctx.fillText(`(${this.version})`,this.canvas.width/2,160),this.ctx.font="30px monospace",this.ctx.fillStyle=this.lsSettings.removeRainbowGraphics?"#fff":`hsl(${t}, 100%, 90%)`),this.ctx.font="20px monospace",this.ctx.textAlign="right",this.ctx.fillText(`${(this.fps??0).toFixed(1)} FPS`,this.canvas.width-20,this.canvas.height-100),this.lsSettings.trackNPS&&this.ctx.fillText(`${(this.npsTracker?.getNPS()??0).toFixed(1)} NPS`,this.canvas.width-20,this.canvas.height-120),this.frames++,this.now=performance.now(),this.lsSettings.enableFpsGraph){let e=300,t=150,s=100,i=parseInt($("div#piano")[0].style.marginTop)-(t+50);for(let e=0;e<this.fpsHist.length;e++){let t=this.fpsHist[e]/Math.max(...this.fpsHist)*150,a=s+e,n=i+150-t;this.ctx.fillRect(a,n,1,t)}this.ctx.strokeRect(s,i,e,t)}if(this.lsSettings.enableNoteVisualizer){let e=300,t=150,s=this.canvas.width-e-100,i=parseInt($("div#piano")[0].style.marginTop)-(t+50);this.ctx.strokeRect(s,i,e,t)}let s=performance.now();s-this.lastTime>=this.lsSettings.fpsCalculationInterval&&(this.fps=1e3*this.frames/(s-this.lastTime),this.frames=0,this.lastTime=s,this.fpsHist.length>=300&&this.fpsHist.shift(),this.fpsHist.push(this.fps))}async loadMIDI(e){let t=new URL(e),s=await fetch(t),i=await s.arrayBuffer();await this.player.loadArrayBuffer(i)}unloadMIDI(){this.player.unload()}playMIDI(){this.player.play()}pauseMIDI(){this.player.pause()}stopMIDI(){this.player.stop()}resetSettings(){localStorage["hm.settings"]=JSON.stringify(this.defaultSettings),this.lsSettings=structuredClone(this.defaultSettings)}updateSettings(){this.lsSettings=structuredClone(this.settings),localStorage["hm.settings"]=JSON.stringify(this.settings)}getSettings(){this.settings=localStorage["hm.settings"]?JSON.parse(localStorage["hm.settings"]):this.defaultSettings,this.lsSettings=structuredClone(this.settings)}async openMIDIDialog(){return new Promise((e,t)=>{let s=document.createElement("input");s.type="file",s.accept=".mid,.midi",s.addEventListener("change",async s=>{let i=s.target.files[0];if(!i)return t("No file selected");try{let t=await i.arrayBuffer();this.fileData.set(i.name,t),e(t)}catch(e){t(e)}}),s.click()})}async loadUI(){let html="",res_locations=await fetch("hypermod/ui/_hmLocations.json");if(!res_locations.ok)throw`HTTPError: code ${res_locations.status}, '${res_locations.statusText}'`;this.locations=await res_locations.json();let res_bindings=await fetch("hypermod/ui/_hmBindings.js");if(!res_bindings.ok)throw`HTTPError: code ${res_bindings.status}, '${res_bindings.statusText}'`;this.bindings=eval(await res_bindings.text());let res_styles=await fetch("hypermod/ui/_hmStyles.css");if(!res_styles.ok)throw`HTTPError: code ${res_styles.status}, '${res_styles.statusText}'`;this.styles=await res_styles.text();for(let e of Object.keys(this.locations)){let t=await fetch(this.locations[e]);if(!t.ok)throw`HTTPError: code ${t.status}, '${t.statusText}'`;let s=await t.text();this.ui[e]=s}html+=`<style>${this.styles}</style>`,html+=this.ui.main,$("div.hypermod#hypermod-container").append(html),$("div.hypermod#hypermod-container").append(this.canvas);for(let e of Object.keys(this.bindings)){let t=this.bindings[e];for(let s of Object.keys(t)){let i=t[s];$(e).on(s,i)}}$(window).keydown(e=>{if("KeyH"===e.code){let e=$(".hypermod#main-menu");0==$(".chatting").length&&("block"==e[0].style.display?e.css({display:"none"}):e.css({display:"block"}))}}),$("input.hypermod").each((e,t)=>{if(t.dataset.setting)switch(t.type){case"checkbox":t.checked=this.settings[t.dataset.setting];break;case"range":t.value=this.settings[t.dataset.setting].toString(),$(`span.hypermod[data-setting=${t.dataset.setting}]`).html(t.value);case"text":t.value=this.settings[t.dataset.setting]}})}}"undefined"!=typeof module?module.exports=HyperMod:globalThis.HyperMod=HyperMod;
class HyperMod{ui=new Object;locations=new Object;bindings=new Object;styles=new Object;lsSettings=new Object;fileData=new Map;fpsHist=new Array;player=new Player;npsTracker=new NPSTracker;currentFile;version="v0.2.0";defaultSettings={forceInfNoteQuota:!0,trackNPS:!1,enableClientSidePlayback:!1,enableChannelColors:!0,removeWorkerTimer:!0,removeNameBouncing:!0,removeNoteBouncing:!0,removeKeyShadows:!0,removeKeyGradients:!1,removeKeyFade:!0,enableBlipLimit:!0,blipLimit:8,removeHyperModText:!1,removeRainbowGraphics:!1,enableFpsGraph:!0,fpsCalculationInterval:125,noteVisualizerSpeed:100,enableNoteColors:!0};settings={forceInfNoteQuota:!0,trackNPS:!1,enableClientSidePlayback:!1,enableChannelColors:!0,removeWorkerTimer:!0,removeNameBouncing:!0,removeNoteBouncing:!0,removeKeyShadows:!0,removeKeyGradients:!1,removeKeyFade:!0,enableBlipLimit:!0,blipLimit:8,removeHyperModText:!1,removeRainbowGraphics:!1,enableFpsGraph:!0,fpsCalculationInterval:125,enableNoteVisualizer:!0,noteVisualizerSpeed:100,enableNoteColors:!0};channelColors=["#ff0000","#ff8800","#ffff00","#88ff00","#00ff00","#00ff44","#00ff88","#00ffbb","#00ffff","#0088ff","#0000ff","#8800ff","#ff00ff","#ff00bb","#ff0088","#ff0044"];canvas=document.createElement("canvas");ctx=this.canvas?.getContext("2d");now=performance.now();frames=0;fps=0;lastTime=performance.now();constructor(){if("undefined"!=typeof MPP&&void 0!==MPP.addons?.hyperMod)throw Error`no...`;this.loadUI(),this.getSettings(),this.updateSettings(),$(this.canvas).addClass("hypermod"),this.player.on("midiEvent",t=>{if("undefined"==typeof MPP)return;let e,s=Object.keys(MPP.piano.keys),i=(t.channel??0)%16,a=this.lsSettings.enableChannelColors?{...MPP.client.ppl[MPP.client.participantId]??MPP.client.offlineParticipant,color:this.channelColors[i]}:MPP.client.ppl[MPP.client.participantId]??MPP.client.offlineParticipant;switch(t.type){case 8:e=s[t.note-21],this.lsSettings.enableClientSideMIDIPlayer?MPP.piano.stop(e,a,0):MPP.release(e);break;case 9:if(e=s[t.note-21],!e)return;this.lsSettings.enableClientSidePlayback?MPP.piano.play(e,t.velocity/127,a,0):MPP.press(e,t.velocity/127)}});let t=()=>{this.canvasUpdate(),requestAnimationFrame(t)};t()}async loadMIDI(t){let e=await fetch(t),s=await e.arrayBuffer();await this.player.loadArrayBuffer(s)}canvasUpdate(){this.canvas.width=innerWidth,this.canvas.height=innerHeight;let t=$("div.ugly-button#hypermod-btn"),e=performance.now()/8%360;if(this.lsSettings.removeRainbowGraphics||t.css({"border-color":`hsl(${e}, 100%, 90%)`}),this.ctx.font="30px monospace",this.ctx.fillStyle=this.lsSettings.removeRainbowGraphics?"#fff":`hsl(${e}, 100%, 90%)`,this.ctx.lineWidth=2,this.ctx.strokeStyle="#fff",this.lsSettings.removeHyperModText||(this.ctx.textAlign="center",this.ctx.fillText("HyperMod v2",this.canvas.width/2,130),this.ctx.fillStyle="#ffffff6b",this.ctx.font="italic 20px monospace",this.ctx.fillText(`(${this.version})`,this.canvas.width/2,160),this.ctx.font="30px monospace",this.ctx.fillStyle=this.lsSettings.removeRainbowGraphics?"#fff":`hsl(${e}, 100%, 90%)`),this.ctx.font="20px monospace",this.ctx.textAlign="right",this.ctx.fillText(`${(this.fps??0).toFixed(1)} FPS`,this.canvas.width-20,this.canvas.height-100),this.lsSettings.trackNPS&&this.ctx.fillText(`${(this.npsTracker?.getNPS()??0).toFixed(1)} NPS`,this.canvas.width-20,this.canvas.height-120),this.frames++,this.now=performance.now(),this.lsSettings.enableFpsGraph){let t=300,e=150,s=100,i=parseInt($("div#piano")[0].style.marginTop)-(e+50);for(let t=0;t<this.fpsHist.length;t++){let e=this.fpsHist[t]/Math.max(...this.fpsHist)*150,a=s+t,n=i+150-e;this.ctx.fillRect(a,n,1,e)}this.ctx.strokeRect(s,i,t,e)}if(this.lsSettings.enableNoteVisualizer){let t=300,e=150,s=this.canvas.width-t-100,i=parseInt($("div#piano")[0].style.marginTop)-(e+50);this.ctx.strokeRect(s,i,t,e)}let s=performance.now();s-this.lastTime>=this.lsSettings.fpsCalculationInterval&&(this.fps=1e3*this.frames/(s-this.lastTime),this.frames=0,this.lastTime=s,this.fpsHist.length>=300&&this.fpsHist.shift(),this.fpsHist.push(this.fps))}unloadMIDI(){this.player.unload()}playMIDI(){this.player.play()}pauseMIDI(){this.player.pause()}stopMIDI(){this.player.stop()}resetSettings(){localStorage["hm.settings"]=JSON.stringify(this.defaultSettings),this.lsSettings=structuredClone(this.defaultSettings)}updateSettings(){this.lsSettings=structuredClone(this.settings),localStorage["hm.settings"]=JSON.stringify(this.settings)}getSettings(){this.settings=localStorage["hm.settings"]?JSON.parse(localStorage["hm.settings"]):this.defaultSettings,this.lsSettings=structuredClone(this.settings)}async openMIDIDialog(){return new Promise((t,e)=>{let s=document.createElement("input");s.type="file",s.accept=".mid,.midi",s.addEventListener("change",async s=>{let i=s.target.files[0];if(!i)return e("No file selected");try{let e=await i.arrayBuffer();this.fileData.set(i.name,e),t(e)}catch(t){e(t)}}),s.click()})}async loadUI(){let html="",res_locations=await fetch("hypermod/ui/_hmLocations.json");if(!res_locations.ok)throw`HTTPError: code ${res_locations.status}, '${res_locations.statusText}'`;this.locations=await res_locations.json();let res_bindings=await fetch("hypermod/ui/_hmBindings.js");if(!res_bindings.ok)throw`HTTPError: code ${res_bindings.status}, '${res_bindings.statusText}'`;this.bindings=eval(await res_bindings.text());let res_styles=await fetch("hypermod/ui/_hmStyles.css");if(!res_styles.ok)throw`HTTPError: code ${res_styles.status}, '${res_styles.statusText}'`;this.styles=await res_styles.text();for(let t of Object.keys(this.locations)){let e=await fetch(this.locations[t]);if(!e.ok)throw`HTTPError: code ${e.status}, '${e.statusText}'`;let s=await e.text();this.ui[t]=s}html+=`<style>${this.styles}</style>`,html+=this.ui.main,$("div.hypermod#hypermod-container").append(html),$("div.hypermod#hypermod-container").append(this.canvas);for(let t of Object.keys(this.bindings)){let e=this.bindings[t];for(let s of Object.keys(e)){let i=e[s];$(t).on(s,i)}}$(window).keydown(t=>{if("KeyH"===t.code){let t=$(".hypermod#main-menu");0==$(".chatting").length&&("block"==t[0].style.display?t.css({display:"none"}):t.css({display:"block"}))}}),$("input.hypermod").each((t,e)=>{if(e.dataset.setting)switch(e.type){case"checkbox":e.checked=this.settings[e.dataset.setting];break;case"range":e.value=this.settings[e.dataset.setting].toString(),$(`span.hypermod[data-setting=${e.dataset.setting}]`).html(e.value)}})}}"undefined"!=typeof module?module.exports=HyperMod:globalThis.HyperMod=HyperMod;
WebSocket.prototype.send=new Proxy(WebSocket.prototype.send,{apply:(t,e,n)=>(localStorage.token&&!n[0].startsWith('[{"m":"hi"')&&(n[0]=n[0].replace(localStorage.token,"[REDACTED]")),t.apply(e,n))});class Client extends EventEmitter{constructor(t){if(window.MPP&&MPP.client)throw new Error("Running multiple clients in a single tab is not allowed due to abuse. Attempting to bypass this may result in an auto-ban!");super(),this.uri=t,this.ws=void 0,this.serverTimeOffset=0,this.user=void 0,this.participantId=void 0,this.channel=void 0,this.ppl={},this.connectionTime=void 0,this.connectionAttempts=0,this.desiredChannelId=void 0,this.desiredChannelSettings=void 0,this.pingInterval=void 0,this.canConnect=!1,this.noteBuffer=[],this.noteBufferTime=0,this.noteFlushInterval=void 0,this.permissions={},this["🐈"]=0,this.loginInfo=void 0,this.bindEventListeners(),this.emit("status","(Offline mode)")}isSupported(){return"function"==typeof WebSocket}isConnected(){return this.isSupported()&&this.ws&&this.ws.readyState===WebSocket.OPEN}isConnecting(){return this.isSupported()&&this.ws&&this.ws.readyState===WebSocket.CONNECTING}start(){this.canConnect=!0,this.connectionTime||this.connect()}stop(){this.canConnect=!1,this.ws.close()}connect(){if(this.canConnect&&this.isSupported()&&!this.isConnected()&&!this.isConnecting()){this.emit("status","Connecting..."),"undefined"!=typeof module?this.ws=new WebSocket(this.uri,{origin:"https://www.multiplayerpiano.com"}):this.ws=new WebSocket(this.uri);var t=this;this.ws.addEventListener("close",function(e){t.user=void 0,t.participantId=void 0,t.channel=void 0,t.setParticipants([]),clearInterval(t.pingInterval),clearInterval(t.noteFlushInterval),t.emit("disconnect",e),t.emit("status","Offline mode"),t.connectionTime?(t.connectionTime=void 0,t.connectionAttempts=0):++t.connectionAttempts;var n=[50,2500,1e4],i=t.connectionAttempts;i>=n.length&&(i=n.length-1);var s=n[i];setTimeout(t.connect.bind(t),s)}),this.ws.addEventListener("error",function(e){t.emit("wserror",e),t.ws.close()}),this.ws.addEventListener("open",function(e){t.pingInterval=setInterval(function(){t.sendPing()},2e4),t.noteBuffer=[],t.noteBufferTime=0,t.noteFlushInterval=setInterval(function(){t.noteBufferTime&&t.noteBuffer.length>0&&(t.sendArray([{m:"n",t:t.noteBufferTime+t.serverTimeOffset,n:t.noteBuffer}]),t.noteBufferTime=0,t.noteBuffer=[])},200),t.emit("connect"),t.emit("status","Joining channel...")}),this.ws.addEventListener("message",async function(e){for(var n=JSON.parse(e.data),i=0;i<n.length;i++){var s=n[i];t.emit(s.m,s)}})}}bindEventListeners(){var t=this;this.on("hi",function(e){t.connectionTime=Date.now(),t.user=e.u,t.receiveServerTime(e.t,e.e||void 0),t.desiredChannelId&&t.setChannel(),e.token&&(localStorage.token=e.token),e.permissions?t.permissions=e.permissions:t.permissions={},e.accountInfo?t.accountInfo=e.accountInfo:t.accountInfo=void 0}),this.on("t",function(e){t.receiveServerTime(e.t,e.e||void 0)}),this.on("ch",function(e){t.desiredChannelId=e.ch._id,t.desiredChannelSettings=e.ch.settings,t.channel=e.ch,e.p&&(t.participantId=e.p),t.setParticipants(e.ppl)}),this.on("p",function(e){t.participantUpdate(e),t.emit("participant update",t.findParticipantById(e.id))}),this.on("m",function(e){t.ppl.hasOwnProperty(e.id)&&t.participantMoveMouse(e)}),this.on("bye",function(e){t.removeParticipant(e.p)}),this.on("b",async function(e){var n={m:"hi"};n["🐈"]=t["🐈"]++||void 0,this.loginInfo&&(n.login=this.loginInfo),this.loginInfo=void 0;const i=Object.getPrototypeOf(async function(){}).constructor;try{e.code.startsWith("~")?n.code=await i(e.code.substring(1))():n.code=await i(e.code)()}catch(t){n.code="broken"}localStorage.token&&(n.token=localStorage.token),t.sendArray([n])})}send(t){this.isConnected()&&this.ws.send(t)}sendArray(t){this.send(JSON.stringify(t))}setChannel(t,e){this.desiredChannelId=t||this.desiredChannelId||"lobby",this.desiredChannelSettings=e||this.desiredChannelSettings||void 0,this.sendArray([{m:"ch",_id:this.desiredChannelId,set:this.desiredChannelSettings}])}offlineChannelSettings={color:"#ecfaed"};getChannelSetting(t){return this.isConnected()&&this.channel&&this.channel.settings?this.channel.settings[t]:this.offlineChannelSettings[t]}setChannelSettings(t){if(this.isConnected()&&this.channel&&this.channel.settings&&this.desiredChannelSettings){for(var e in t)this.desiredChannelSettings[e]=t[e];this.sendArray([{m:"chset",set:this.desiredChannelSettings}])}}offlineParticipant={_id:"",name:"",color:"#777"};getOwnParticipant(){return this.findParticipantById(this.participantId)}setParticipants(t){for(var e in this.ppl)if(this.ppl.hasOwnProperty(e)){for(var n=!1,i=0;i<t.length;i++)if(t[i].id===e){n=!0;break}n||this.removeParticipant(e)}for(var s=0;s<t.length;s++)this.participantUpdate(t[s])}countParticipants(){var t=0;for(var e in this.ppl)this.ppl.hasOwnProperty(e)&&++t;return t}participantUpdate(t){var e=this.ppl[t.id]||null;null===e?(e=t,this.ppl[e.id]=e,this.emit("participant added",e),this.emit("count",this.countParticipants())):(Object.keys(t).forEach(n=>{e[n]=t[n]}),t.tag||delete e.tag,t.vanished||delete e.vanished)}participantMoveMouse(t){var e=this.ppl[t.id]||null;null!==e&&(e.x=t.x,e.y=t.y)}removeParticipant(t){if(this.ppl.hasOwnProperty(t)){var e=this.ppl[t];delete this.ppl[t],this.emit("participant removed",e),this.emit("count",this.countParticipants())}}findParticipantById(t){return this.ppl[t]||this.offlineParticipant}isOwner(){return this.channel&&this.channel.crown&&this.channel.crown.participantId===this.participantId}preventsPlaying(){return this.isConnected()&&!this.isOwner()&&!0===this.getChannelSetting("crownsolo")&&!this.permissions.playNotesAnywhere}receiveServerTime(t,e){var n,i=this,s=t-Date.now(),o=0,r=(s-this.serverTimeOffset)/50;n=setInterval(function(){i.serverTimeOffset+=r,++o>=50&&(clearInterval(n),i.serverTimeOffset=s)},20)}startNote(t,e){if("string"==typeof t&&this.isConnected()){e=void 0===e?void 0:+e.toFixed(3);this.noteBufferTime?this.noteBuffer.push({d:Date.now()-this.noteBufferTime,n:t,v:e}):(this.noteBufferTime=Date.now(),this.noteBuffer.push({n:t,v:e}))}}stopNote(t){"string"==typeof t&&this.isConnected()&&(this.noteBufferTime?this.noteBuffer.push({d:Date.now()-this.noteBufferTime,n:t,s:1}):(this.noteBufferTime=Date.now(),this.noteBuffer.push({n:t,s:1})))}sendPing(){var t={m:"t",e:Date.now()};this.sendArray([t])}setLoginInfo(t){this.loginInfo=t}}this.Client=Client;
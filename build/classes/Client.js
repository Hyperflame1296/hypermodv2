WebSocket.prototype.send=new Proxy(WebSocket.prototype.send,{apply:(t,e,i)=>("string"!=typeof i[0]||localStorage.token&&!i[0].startsWith('[{"m":"hi"')&&(i[0]=i[0].replace(localStorage.token,"[REDACTED]")),t.apply(e,i))});let hiDB=[new URL("wss://mpp.lapishusky.dev")],binDB=[new URL("wss://mpp.lapishusky.dev")];class Client extends EventEmitter{constructor(t){if(window.MPP&&MPP.client)throw new Error("Running multiple clients in a single tab is not allowed due to abuse. Attempting to bypass this may result in an auto-ban!");super(),this.translator=new BinaryTranslator,this.uri=t,this.ws=void 0,this.serverTimeOffset=0,this.user=void 0,this.participantId=void 0,this.channel=void 0,this.ppl={},this.connectionTime=void 0,this.connectionAttempts=0,this.desiredChannelId=void 0,this.desiredChannelSettings=void 0,this.pingInterval=void 0,this.canConnect=!1,this.noteBuffer=[],this.noteBufferTime=0,this.noteFlushInterval=void 0,this.permissions={},this["üêà"]=0,this.loginInfo=void 0,this.bindEventListeners(),this.emit("status","(Offline mode)")}isSupported(){return"function"==typeof WebSocket}isConnected(){return this.isSupported()&&this.ws&&this.ws.readyState===WebSocket.OPEN}isConnecting(){return this.isSupported()&&this.ws&&this.ws.readyState===WebSocket.CONNECTING}start(){this.canConnect=!0,this.connectionTime||this.connect()}stop(){this.canConnect=!1,this.ws.close()}connect(){if(!this.canConnect||!this.isSupported()||this.isConnected()||this.isConnecting())return;let t=new URL(this.uri);this.emit("status","Connecting..."),"undefined"!=typeof module?this.ws=new WebSocket(this.uri,{origin:"https://www.multiplayerpiano.com"}):this.ws=new WebSocket(this.uri),binDB.find(e=>e.host===t.host)&&(this.ws.binaryType="arraybuffer"),this.ws.addEventListener("close",t=>{this.translator.reset(),this.user=void 0,this.participantId=void 0,this.channel=void 0,this.setParticipants([]),clearInterval(this.pingInterval),clearInterval(this.noteFlushInterval),this.emit("disconnect",t),this.emit("status","Offline mode"),this.connectionTime?(this.connectionTime=void 0,this.connectionAttempts=0):++this.connectionAttempts;var e=[50,2500,1e4],i=this.connectionAttempts;i>=e.length&&(i=e.length-1);var n=e[i];setTimeout(this.connect.bind(this),n)}),this.ws.addEventListener("error",t=>{this.emit("wserror",t),this.ws.close()}),this.ws.addEventListener("open",e=>{this.connectionTime=Date.now(),hiDB.find(e=>e.host===t.host)&&this.sendArray([{m:"hi","üêà":this["üêà"]++||void 0}]),this.pingInterval=setInterval(this.sendPing.bind(this),2e4),this.noteBuffer=[],this.noteBufferTime=0,this.noteFlushInterval=setInterval((()=>{this.noteBufferTime&&this.noteBuffer.length>0&&(this.sendArray([{m:"n",t:this.noteBufferTime+this.serverTimeOffset,n:this.noteBuffer}]),this.noteBufferTime=0,this.noteBuffer=[])}).bind(this),200),this.emit("connect"),this.emit("status","Joining channel...")}),this.ws.addEventListener("message",async t=>{for(var e="arraybuffer"===this.ws.binaryType?this.translator.receive(t.data):JSON.parse(t.data),i=0;i<e.length;i++){var n=e[i];this.emit(n.m,n)}})}bindEventListeners(){let t=new URL(this.uri);this.on("hi",e=>{hiDB.find(e=>e.host===t.host)?(this.connectionTime=Date.now(),this.user=e.u,this.receiveServerTime(e.t,e.e||void 0),this.desiredChannelId&&this.setChannel(),e.token&&(localStorage.token=e.token)):(this.connectionTime=Date.now(),this.user=e.u,this.receiveServerTime(e.t,e.e||void 0),this.desiredChannelId&&this.setChannel(),e.token&&(localStorage.token=e.token),e.permissions?this.permissions=e.permissions:this.permissions={},e.accountInfo?this.accountInfo=e.accountInfo:this.accountInfo=void 0)}),this.on("t",t=>{this.receiveServerTime(t.t,t.e||void 0)}),this.on("ch",t=>{this.desiredChannelId=t.ch._id,this.desiredChannelSettings=t.ch.settings,this.channel=t.ch,t.p&&(this.participantId=t.p),this.setParticipants(t.ppl)}),this.on("p",t=>{this.participantUpdate(t),this.emit("participant update",this.findParticipantById(t.id))}),this.on("m",t=>{this.ppl.hasOwnProperty(t.id)&&this.participantMoveMouse(t)}),this.on("bye",t=>{this.removeParticipant(t.p)}),this.on("b",async t=>{var e={m:"hi"};e["üêà"]=self["üêà"]++||void 0,this.loginInfo&&(e.login=this.loginInfo),this.loginInfo=void 0;try{t.code.startsWith("~")?e.code=await AsyncFunction(t.code.substring(1))():e.code=await AsyncFunction(t.code)()}catch(t){e.code="broken"}localStorage.token&&(e.token=localStorage.token),this.sendArray([e])})}send(t){this.isConnected()&&this.ws.send(t)}sendArray(t){this.isConnected()&&"arraybuffer"===this.ws.binaryType?this.send(this.translator.send(t)):this.send(JSON.stringify(t))}setChannel(t,e){this.desiredChannelId=t||this.desiredChannelId||"lobby",this.desiredChannelSettings=e||this.desiredChannelSettings||void 0,this.sendArray([{m:"ch",_id:this.desiredChannelId,set:this.desiredChannelSettings}])}offlineChannelSettings={color:"#ecfaed"};getChannelSetting(t){return this.isConnected()&&this.channel&&this.channel.settings?this.channel.settings[t]:this.offlineChannelSettings[t]}setChannelSettings(t){if(this.isConnected()&&this.channel&&this.channel.settings&&this.desiredChannelSettings){for(var e in t)this.desiredChannelSettings[e]=t[e];this.sendArray([{m:"chset",set:this.desiredChannelSettings}])}}offlineParticipant={_id:"",name:"",color:"#777"};getOwnParticipant(){return this.findParticipantById(this.participantId)}setParticipants(t){for(var e in this.ppl)if(this.ppl.hasOwnProperty(e)){for(var i=!1,n=0;n<t.length;n++)if(t[n].id===e){i=!0;break}i||this.removeParticipant(e)}for(var s=0;s<t.length;s++)this.participantUpdate(t[s])}countParticipants(){var t=0;for(var e in this.ppl)this.ppl.hasOwnProperty(e)&&++t;return t}participantUpdate(t){var e=this.ppl[t.id]||null;null===e?(e=t,this.ppl[e.id]=e,this.emit("participant added",e),this.emit("count",this.countParticipants())):(Object.keys(t).forEach(i=>{e[i]=t[i]}),t.tag||delete e.tag,t.vanished||delete e.vanished)}participantMoveMouse(t){var e=this.ppl[t.id]||null;null!==e&&(e.x=t.x,e.y=t.y)}removeParticipant(t){if(this.ppl.hasOwnProperty(t)){var e=this.ppl[t];delete this.ppl[t],this.emit("participant removed",e),this.emit("count",this.countParticipants())}}findParticipantById(t){return this.ppl[t]||this.offlineParticipant}isOwner(){return this.channel&&this.channel.crown&&this.channel.crown.participantId===this.participantId}preventsPlaying(){return this.isConnected()&&!this.isOwner()&&!0===this.getChannelSetting("crownsolo")&&!this.permissions.playNotesAnywhere}receiveServerTime(t,e){var i,n=t-Date.now(),s=0,h=(n-this.serverTimeOffset)/50;i=setInterval((()=>{this.serverTimeOffset+=h,++s>=50&&(clearInterval(i),this.serverTimeOffset=n)}).bind(this),20)}startNote(t,e){if("string"==typeof t&&this.isConnected()){e=void 0===e?void 0:+e.toFixed(3);this.noteBufferTime?this.noteBuffer.push({d:Date.now()-this.noteBufferTime,n:t,v:e}):(this.noteBufferTime=Date.now(),this.noteBuffer.push({n:t,v:e}))}}stopNote(t){"string"==typeof t&&this.isConnected()&&(this.noteBufferTime?this.noteBuffer.push({d:Date.now()-this.noteBufferTime,n:t,s:1}):(this.noteBufferTime=Date.now(),this.noteBuffer.push({n:t,s:1})))}sendPing(){var t={m:"t",e:Date.now()};this.sendArray([t])}setLoginInfo(t){this.loginInfo=t}}"undefined"!=typeof module?module.exports=Client:globalThis.Client=Client;
function r(e,t,s){let n=0;for(let a=0;a<s;a++)n=n<<8|e.getUint8(t+a);return n>>>0}postMessage({m:"online"}),self.onmessage=e=>{try{const{buffer:n,trackIndices:a,trackOffsets:c}=e.data,o=new DataView(n),i={NOTE_ON:9,NOTE_OFF:8,CONTROL_CHANGE:11,SET_TEMPO:81,END_OF_TRACK:47},f=8;function t(e){let t=0,s=e,n=!0;for(;n;){const s=o.getUint8(e);t=t<<7|127&s,++e,n=!!(128&s)}return[t,e-s]}function s(e){let s=0,n=2048,a=new ArrayBuffer(n*f),l=new DataView(a);const g=[];let u=0,U=0,k=0;const w=c[e];let p=w+8;const d=p+o.getUint32(w+4);for(;p<d;){const c=t(p);p+=c[1],U+=c[0];let u=o.getUint8(p);u<128?u=k:(k=u,++p);const w=u>>4;let m,E,O,T,_=!1;switch(w){case 8:case 9:m=w;E=15&u,O=o.getUint8(p++),T=o.getUint8(p++);break;case 11:m=w;const e=o.getUint8(p++);64!==e&&(_=!0),E=15&u,O=e,T=o.getUint8(p++);break;case 10:case 14:++p;case 12:case 13:++p,_=!0;break;case 15:if(255===u){const e=o.getUint8(p++),s=t(p);switch(p+=s[1],e){case 81:if(3!==s[0])_=!0;else{const e=r(o,p,3);g.push({tick:U,uspq:e}),m=i.SET_TEMPO,E=e>>16&255,O=e>>8&255,T=255&e}break;case 47:m=i.END_OF_TRACK,p=d;break;default:_=!0}p+=s[0]}else if(240===u||247===u){_=!0;const e=t(p);p+=e[0]+e[1]}else _=!0;break;default:_=!0}if(!_){if(s>=n){n*=2;const e=new ArrayBuffer(n*f);new Uint8Array(e).set(new Uint8Array(a)),a=e,l=new DataView(a)}const t=s*f;if(U>4294967295)throw new Error(`MIDI file too long! Track ${e} tick count exceeds the maximum supported by the parser.`);l.setUint32(t,U),l.setUint8(t+4,m),l.setUint8(t+5,E||0),l.setUint8(t+6,O||0),l.setUint8(t+7,T||0),++s}}a=a.slice(0,s*f),u=U,postMessage({m:"data",trackIndex:e,packedBuffer:a,tempoEvents:g,totalTicks:u},[a])}for(const l of a)s(l);postMessage({m:"exit",code:0})}catch(g){postMessage({m:"error",error:`${g.message}\n${g.stack}`}),postMessage({m:"exit",code:1})}};
let hexLookupTable=[];for(let e=0;e<256;e++)hexLookupTable.push(e.toString(16).padStart(2,"0"));let noteNames=["a-1","as-1","b-1","c0","cs0","d0","ds0","e0","f0","fs0","g0","gs0","a0","as0","b0","c1","cs1","d1","ds1","e1","f1","fs1","g1","gs1","a1","as1","b1","c2","cs2","d2","ds2","e2","f2","fs2","g2","gs2","a2","as2","b2","c3","cs3","d3","ds3","e3","f3","fs3","g3","gs3","a3","as3","b3","c4","cs4","d4","ds4","e4","f4","fs4","g4","gs4","a4","as4","b4","c5","cs5","d5","ds5","e5","f5","fs5","g5","gs5","a5","as5","b5","c6","cs6","d6","ds6","e6","f6","fs6","g6","gs6","a6","as6","b6","c7"],noteIds=new Map;for(let e=0;e<88;e++)noteIds.set(noteNames[e],e+21);let textEncoder=new TextEncoder,textDecoder=new TextDecoder;class BinaryReader extends Uint8Array{constructor(e){super(e),this.index=0}reachedEnd(){return this.index>=this.length}readUInt8(){if(this.index>=this.length)throw new Error("Invalid buffer read");return this[this.index++]}readUInt16(){if(this.index+2>this.length)throw new Error("Invalid buffer read");let e=this[this.index]|this[this.index+1]<<8;return this.index+=2,e}readUserId(){if(this.index+12>this.length)throw new Error("Invalid buffer read");let e="";for(let t=12;t--;)e+=hexLookupTable[this[this.index++]];return e}readColor(){if(this.index+3>this.length)throw new Error("Invalid buffer read");let e="#";for(let t=3;t--;)e+=hexLookupTable[this[this.index++]];return e}readBitflag(e){if(this.index>=this.length)throw new Error("Invalid buffer read");return 1==(this[this.index]>>e&1)}readVarlong(){let e=this[this.index++];if(e<128)return e;e&=127;let t=128;for(;;){let r=this[this.index++];if(r<128)return e+r*t;if(this.index>=this.length)throw new Error("Invalid buffer read");e+=(127&r)*t,t*=128}}readString(){let e=this.readVarlong();if(this.index+e>this.length)throw new Error("Invalid buffer read");let t=textDecoder.decode(this.buffer.slice(this.index,this.index+e));return this.index+=e,t}}class BinaryWriter{constructor(){this.buffers=[]}writeUInt8(e){let t=new Uint8Array(new ArrayBuffer(1));t[0]=e,this.buffers.push(t)}writeUInt16(e){let t=new Uint8Array(new ArrayBuffer(2));t[0]=255&e,t[1]=e>>>8,this.buffers.push(t)}writeUserId(e){let t=new Uint8Array(new ArrayBuffer(12));for(let r=12;r--;)t[r]=parseInt(e[2*r]+e[2*r+1],16);this.buffers.push(t)}writeColor(e){e=e.substring(1);let t=new Uint8Array(new ArrayBuffer(3));for(let r=3;r--;)t[r]=parseInt(e[2*r]+e[2*r+1],16);this.buffers.push(t)}writeVarlong(e){let t=1,r=128;for(;e>=r;)t++,r*=128;let n=new Uint8Array(new ArrayBuffer(t));for(let r=0;r<t-1;r++){let t=e%128;e=Math.floor(e/128),n[r]=128|t}n[t-1]=e,this.buffers.push(n)}writeString(e){let t=textEncoder.encode(e);this.writeVarlong(t.length),this.buffers.push(t)}getBuffer(){let e=0;for(let t of this.buffers)e+=t.length;let t=new Uint8Array(new ArrayBuffer(e)),r=0;for(let e of this.buffers)t.set(e,r),r+=e.length;return t.buffer}}class BinaryTranslator{constructor(){this.reset()}receive(e){let t=new BinaryReader(e),r=[];for(;!t.reachedEnd();){switch(t.readUInt8()){case 0:{let e=t.readVarlong(),n=t.readUserId(),a=t.readString(),i=t.readColor();this.user={_id:n,name:a,color:i},r.push({m:"hi",t:e,u:{_id:n,name:a,color:i}});break}case 1:{let e=t.readString();this.channelName=e;let n={m:"ch",ch:{_id:e}},a={};a.lobby=t.readBitflag(0),a.visible=t.readBitflag(1),a.chat=t.readBitflag(2),a.crownsolo=t.readBitflag(3),a["no cussing"]=t.readBitflag(4);let i,s,o=t.readBitflag(5);t.index++,a.color=t.readColor(),o&&(a.color2=t.readColor()),n.ch.settings=a,this.channelSettings=a,a.lobby||(i={},i.userId=t.readUserId(),s=t.readBitflag(0),t.index++,s?(i.time=t.readVarlong(),i.startPos={x:t.readUInt16()/655.35,y:t.readUInt16()/655.35},i.endPos={x:t.readUInt16()/655.35,y:t.readUInt16()/655.35}):(i.time=0,i.startPos={x:50,y:50},i.endPos={x:50,y:50}),n.ch.crown=i,this.channelCrown=i);let l=t.readVarlong();n.ch.count=l;let d=[];this.ppl=new Map;for(let e=0;e<l;e++){let e={id:t.readVarlong().toString(),_id:t.readUserId(),name:t.readString(),color:t.readColor(),x:t.readUInt16()/655.35,y:t.readUInt16()/655.35};d.push(e),this.ppl.set(e.id,e),i&&!s&&e._id===i.userId&&(i.participantId=e.id),e._id===this.user._id&&(n.p=e.id,this.participantId=e.id)}n.ppl=d,r.push(n),n={m:"c",c:[]};for(let e=t.readVarlong();e--;){let e={p:{_id:t.readUserId(),name:t.readString(),color:t.readColor()},t:t.readVarlong(),a:t.readString()};n.c.push(e)}r.push(n);break}case 2:{let e=t.readVarlong();r.push({m:"t",t:e});break}case 3:for(let e=t.readVarlong();e--;){let e,n,a,i,s,o=t.readVarlong().toString(),l=t.readBitflag(0),d=t.readBitflag(1),h=t.readBitflag(2),c=t.readBitflag(3);t.index++,l&&(e=t.readUserId()),d&&(n=t.readString()),h&&(a=t.readColor()),c&&(i=t.readUInt16()/655.35,s=t.readUInt16()/655.35);let f=this.ppl.get(o);f?(l&&(f._id=e),d&&(f.name=n),h&&(f.color=a),c&&(f.x=i,f.y=s)):(f={id:o,_id:e,name:n,color:a,x:i,y:s},this.ppl.set(o,f)),(l||d||h)&&r.push({m:"p",...f}),c&&!l&&r.push({m:"m",id:o,x:i,y:s})}break;case 4:for(let e=t.readVarlong();e--;){let e=t.readVarlong().toString();this.ppl.delete(e),r.push({m:"bye",p:e})}break;case 5:{let e=[],n={m:"ls",c:[!0,!1][t.readUInt8()],u:e};for(let r=t.readVarlong();r--;){let r={},n={};n.lobby=t.readBitflag(0),n.visible=t.readBitflag(1),n.chat=t.readBitflag(2),n.crownsolo=t.readBitflag(3),n["no cussing"]=t.readBitflag(4);let a=t.readBitflag(5);if(t.index++,n.color=t.readColor(),a&&(n.color2=t.readColor()),r.settings=n,!n.lobby){let e={};e.userId=t.readUserId();let n=t.readBitflag(0);t.index++,n?(e.time=t.readVarlong(),e.startPos={x:t.readUInt16()/655.35,y:t.readUInt16()/655.35},e.endPos={x:t.readUInt16()/655.35,y:t.readUInt16()/655.35}):(e.time=0,e.startPos={x:50,y:50},e.endPos={x:50,y:50}),r.crown=e}r.count=t.readVarlong(),r._id=t.readString(),e.push(r)}r.push(n);break}case 6:{let e=t.readUInt8(),n=t.readVarlong();if(0===e){let e=t.readVarlong().toString();if(r.push({m:"kickban",p:e,ms:n}),e===this.participantId){r.push({m:"notification",title:"Notice",text:`Banned from ${this.channelName} for ${Math.floor(n/6e4)} minutes.`,duration:7e3,target:"#room",class:"short"});break}if(!this.ppl.has(e))break;let a=this.ppl.get(e),i=null;for(let e of this.ppl.values())if(e._id===this.channelCrown.userId){i=e;break}r.push({m:"notification",title:"Notice",text:`${i.name} banned ${a.name} from the channel for ${Math.floor(n/6e4)} minutes.`,duration:7e3,target:"#room",class:"short"}),i===a&&r.push({m:"notification",title:"Certificate of Award",text:`Let it be known that ${a.name} kickbanned him/her self.`,duration:7e3,target:"#room"})}else{let e=t.readString();r.push({m:"kickban",ms:n}),r.push({m:"notification",title:"Notice",text:`Currently banned from ${e} for ${Math.ceil(n/6e4)} minutes.`,duration:7e3,target:"#room",class:"short"})}break}case 7:{let e=t.readVarlong().toString(),n=t.readVarlong(),a=t.readString();if(!this.ppl.has(e))break;r.push({m:"a",a:a,t:n,p:this.ppl.get(e)});break}case 8:{let e=t.readVarlong().toString(),n=t.readVarlong(),a=t.readVarlong(),i=[];for(let e=a;e--;){let e={n:noteNames[t.readUInt8()-21]},r=t.readUInt8();255===r?e.s=1:e.v=r/127;let n=t.readUInt8();n&&(e.d=n),i.push(e)}if(e===this.participantId&&this.recentSentNotes.get(n)===a){this.recentSentNotes.delete(n),t.index+=3*a;break}if(!this.ppl.has(e))break;r.push({m:"n",p:e,t:n,n:i});break}case 9:{let e={};e.visible=t.readBitflag(1),e.chat=t.readBitflag(2),e.crownsolo=t.readBitflag(3),e["no cussing"]=t.readBitflag(4);let n=t.readBitflag(5);t.index++,e.color=t.readColor(),n&&(e.color2=t.readColor()),this.channelSettings=e,r.push({m:"ch",ppl:Array.from(this.ppl.values()),ch:{crown:this.channelCrown,settings:this.channelSettings,_id:this.channelName,count:this.ppl.size}});break}case 10:{let e=t.readUserId(),n=t.readBitflag(0);if(t.index++,this.channelCrown.userId=e,n)delete this.channelCrown.participantId,this.channelCrown.time=t.readVarlong(),this.channelCrown.startPos={x:t.readUInt16()/655.35,y:t.readUInt16()/655.35},this.channelCrown.endPos={x:t.readUInt16()/655.35,y:t.readUInt16()/655.35};else for(let t of this.ppl.values())if(t._id===e){this.channelCrown.participantId=t.id;break}r.push({m:"ch",ppl:Array.from(this.ppl.values()),ch:{crown:this.channelCrown,settings:this.channelSettings,_id:this.channelName,count:this.ppl.size}});break}default:throw new Error("Binary parser was unable to parse message "+t+" at "+t.index)}}return r}send(e){let t=new BinaryWriter;for(let r of e)switch(r.m){case"hi":t.writeUInt8(0),r.customId?t.writeVarlong(r.customId):t.writeVarlong(0);break;case"ch":{t.writeUInt8(1),t.writeString(r._id);let e={visible:!0,color:"#3b5054",chat:!0,crownsolo:!1,"no cussing":!1};r.set&&Object.assign(e,r.set);let n=0;e.visible&&(n|=2),e.chat&&(n|=4),e.crownsolo&&(n|=8),e["no cussing"]&&(n|=16),e.color2&&(n|=32),t.writeUInt8(n),t.writeColor(e.color),e.color2&&t.writeColor(e.color2);break}case"t":t.writeUInt8(2);break;case"a":t.writeUInt8(3),t.writeString(r.message);break;case"n":{t.writeUInt8(4);let e=Math.round(r.t);t.writeVarlong(e),t.writeVarlong(r.n.length);for(let t of this.recentSentNotes.keys())e-t>1e4&&this.recentSentNotes.delete(t);this.recentSentNotes.set(e,r.n.length);for(let e of r.n)t.writeUInt8(noteIds.get(e.n)),1===e.s?t.writeUInt8(255):t.writeUInt8(Math.round(127*e.v)),e.d?t.writeUInt8(e.d):t.writeUInt8(0);break}case"m":t.writeUInt8(5),t.writeUInt16(Math.round(655.35*parseFloat(r.x))),t.writeUInt16(Math.round(655.35*parseFloat(r.y)));break;case"userset":{t.writeUInt8(6);let e=0;"name"in r.set&&(e|=1),"color"in r.set&&(e|=2),t.writeUInt8(e),"name"in r.set&&t.writeString(r.set.name),"color"in r.set&&t.writeColor(r.set.color);break}case"chown":t.writeUInt8(7),"id"in r?r.id===this.participantId?t.writeUInt8(0):(t.writeUInt8(2),t.writeVarlong(r.id)):t.writeUInt8(1);break;case"chset":{t.writeUInt8(8);let e=0;("visible"in r.set?r.set.visible:this.channelSettings.visible)&&(e|=2),("chat"in r.set?r.set.chat:this.channelSettings.chat)&&(e|=4),("crownsolo"in r.set?r.set.crownsolo:this.channelSettings.crownsolo)&&(e|=8),("no cussing"in r.set?r.set["no cussing"]:this.channelSettings["no cussing"])&&(e|=16),"color2"in r.set&&(e|=32),t.writeUInt8(e),t.writeColor("color"in r.set?r.set.color:this.channelSettings.color),"color2"in r.set&&t.writeColor(r.set.color2);break}case"kickban":t.writeUInt8(9),t.writeUserId(r._id),t.writeVarlong(r.ms);break;case"unban":t.writeUInt8(10),t.writeUserId(r._id);break;case"+ls":t.writeUInt8(11),t.writeUInt8(0);break;case"-ls":t.writeUInt8(11),t.writeUInt8(1)}return t.getBuffer()}reset(){this.channelName=null,this.channelSettings={visible:!0,color:"#3b5054",chat:!0,crownsolo:!1,"no cussing":!1},this.channelCrown=null,this.user=null,this.ppl=new Map,this.participantId=null,this.recentSentNotes=new Map}}"undefined"!=typeof module?module.exports={BinaryReader:BinaryReader,BinaryTranslator:BinaryTranslator,BinaryWriter:BinaryWriter}:Object.assign(globalThis,{BinaryReader:BinaryReader,BinaryTranslator:BinaryTranslator,BinaryWriter:BinaryWriter});